!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t,n){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.ContentScriptType=t.SettingStorage=t.AppType=t.SettingItemType=t.ToolbarButtonLocation=t.isContextMenuItemLocation=t.MenuItemLocation=t.ModelType=t.ImportModuleOutputFormat=t.FileSystemItem=void 0,function(e){e.File="file",e.Directory="directory"}(t.FileSystemItem||(t.FileSystemItem={})),function(e){e.Markdown="md",e.Html="html"}(t.ImportModuleOutputFormat||(t.ImportModuleOutputFormat={})),function(e){e[e.Note=1]="Note",e[e.Folder=2]="Folder",e[e.Setting=3]="Setting",e[e.Resource=4]="Resource",e[e.Tag=5]="Tag",e[e.NoteTag=6]="NoteTag",e[e.Search=7]="Search",e[e.Alarm=8]="Alarm",e[e.MasterKey=9]="MasterKey",e[e.ItemChange=10]="ItemChange",e[e.NoteResource=11]="NoteResource",e[e.ResourceLocalState=12]="ResourceLocalState",e[e.Revision=13]="Revision",e[e.Migration=14]="Migration",e[e.SmartFilter=15]="SmartFilter",e[e.Command=16]="Command"}(t.ModelType||(t.ModelType={})),function(e){e.File="file",e.Edit="edit",e.View="view",e.Note="note",e.Tools="tools",e.Help="help",e.Context="context",e.NoteListContextMenu="noteListContextMenu",e.EditorContextMenu="editorContextMenu",e.FolderContextMenu="folderContextMenu",e.TagContextMenu="tagContextMenu"}(r=t.MenuItemLocation||(t.MenuItemLocation={})),t.isContextMenuItemLocation=function(e){return[r.Context,r.NoteListContextMenu,r.EditorContextMenu,r.FolderContextMenu,r.TagContextMenu].includes(e)},function(e){e.NoteToolbar="noteToolbar",e.EditorToolbar="editorToolbar"}(t.ToolbarButtonLocation||(t.ToolbarButtonLocation={})),function(e){e[e.Int=1]="Int",e[e.String=2]="String",e[e.Bool=3]="Bool",e[e.Array=4]="Array",e[e.Object=5]="Object",e[e.Button=6]="Button"}(t.SettingItemType||(t.SettingItemType={})),function(e){e.Desktop="desktop",e.Mobile="mobile",e.Cli="cli"}(t.AppType||(t.AppType={})),function(e){e[e.Database=1]="Database",e[e.File=2]="File"}(t.SettingStorage||(t.SettingStorage={})),function(e){e.MarkdownItPlugin="markdownItPlugin",e.CodeMirrorPlugin="codeMirrorPlugin"}(t.ContentScriptType||(t.ContentScriptType={}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=joplin},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Settings=t.SettingDefaults=void 0;const i=n(1),o=n(0);t.SettingDefaults={RenderingServer:"http://www.plantuml.com/plantuml",RenderingType:{public:"Official public server",private:"Private server"},RenderingFormats:{svg:"Vector Image (svg)",png:"Raster Image (png)",txt:"AsciiArt (txt)"}};t.Settings=class{constructor(){this._config={renderingType:{value:Object.keys(t.SettingDefaults.RenderingType)[0],type:o.SettingItemType.String,section:"plantUML.settings",public:!0,advanced:!1,isEnum:!0,options:t.SettingDefaults.RenderingType,label:"Rendering: Type",description:"Type of renderer used to parse the PlantUML syntax and create the image. "+t.SettingDefaults.RenderingType.public+": "+t.SettingDefaults.RenderingServer+" ; "+t.SettingDefaults.RenderingType.private+": Host taken from the next option"},renderingServer:{value:t.SettingDefaults.RenderingServer,type:o.SettingItemType.String,section:"plantUML.settings",public:!0,advanced:!1,label:"Rendering: Private server host (optional)",description:'Private rendering server for plantUML. This server is used only if the Rendering Type is "'+t.SettingDefaults.RenderingType.private+'"'},renderingFormats:{value:Object.keys(t.SettingDefaults.RenderingFormats)[0],type:o.SettingItemType.String,section:"plantUML.settings",public:!0,advanced:!1,isEnum:!0,options:t.SettingDefaults.RenderingFormats,label:"Rendering: Output image format",description:"Type of image format generated while rendering the diagram."},diagramHeaderFile:{value:"",type:o.SettingItemType.String,section:"plantUML.settings",public:!0,advanced:!1,label:"Diagram: Header file",description:"Path to the file containing the diagram header. The content of this file will be injected at the begin of each plantUML diagram in your notes."}},this._checks={renderingServer:e=>e.replace(/\/$/,"")}}get(e){if(e in this._config)return this._config[e].value;throw"Setting not found: "+e}toObject(){return Object.keys(this._config).reduce((e,t)=>(e[t]=this._config[t].value,e),{})}register(){return r(this,void 0,void 0,(function*(){yield i.default.settings.registerSection("plantUML.settings",{label:"PlantUML",iconName:"fa fa-project-diagram",description:"PlantUML allows you to render UML diagrams using the syntax defined at https://plantuml.com. For more info on the plugin: https://github.com/marc0l92/joplin-plugin-plantUML#readme"}),yield i.default.settings.registerSettings(this._config),yield this.read()}))}getOrDefault(e,t,n){return r(this,void 0,void 0,(function*(){return!e||e.keys.includes(n)?yield i.default.settings.value(n):t}))}read(e){return r(this,void 0,void 0,(function*(){for(let t in this._config)this._config[t].value=yield this.getOrDefault(e,this._config[t].value,t),t in this._checks&&(this._config[t].value=this._checks[t](this._config[t].value),yield i.default.settings.setValue(t,this._config[t].value))}))}}},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(1),o=n(0),a=n(0),s=n(2),c=n(6),u=n(14),l=n(15),d=n(4),g=n(16),f=n(4),p=i.default.require("fs-extra"),h={MarkdownFenceId:"plantuml",DiagramsCacheFolder:`${g.tmpdir}${f.sep}joplin-plantUml2-plugin${f.sep}`},m="```plantuml\n\n```",v={Fence:"plantUML-fenceTemplate"};function y(){p.rmdirSync(h.DiagramsCacheFolder,{recursive:!0}),p.mkdirSync(h.DiagramsCacheFolder,{recursive:!0})}i.default.plugins.register({onStart:function(){return r(this,void 0,void 0,(function*(){const e=new s.Settings,t=new c.PlantUMLRenderer(e),n=new u.View(e),g=new l.ObjectsCache;y(),yield e.register(),i.default.settings.onChange(t=>r(this,void 0,void 0,(function*(){yield e.read(t),g.clear(),y()}))),yield i.default.commands.register({name:v.Fence,label:"Insert PlantUML block template",iconName:"fa fa-pencil",execute:()=>r(this,void 0,void 0,(function*(){yield i.default.commands.execute("insertText",m)}))});const f=Object.values(v).map(e=>({commandName:e}));yield i.default.views.menus.create("menu-plantUML","PlantUML",f,a.MenuItemLocation.Tools),yield i.default.contentScripts.register(o.ContentScriptType.MarkdownItPlugin,h.MarkdownFenceId,"./contentScript/contentScript.js"),yield i.default.contentScripts.onMessage(h.MarkdownFenceId,i=>r(this,void 0,void 0,(function*(){let o="";try{const a=yield function(e){return r(this,void 0,void 0,(function*(){let t="";if(e)try{const n=d.resolve(e);t=yield p.readFile(n,"utf8")}catch(e){console.error("DiagramHeader file reading error:",e)}return t}))}(e.get("diagramHeaderFile"));i.content=function(e,t){if("@"===e[0]){const n=e.indexOf("\n")+1;return e.slice(0,n)+t+"\n"+e.slice(n)}return t+"\n"+e}(i.content,a);let s=g.getCachedObject(i.content);s||(s=yield t.execute(i.content),g.addCachedObject(i.content,s),function(e,t,n){switch(n){case"svg":const n=`${h.DiagramsCacheFolder}${e}.svg`;p.writeFile(n,t,"base64");break;case"png":const r=`${h.DiagramsCacheFolder}${e}.png`;p.writeFile(r,t,"base64")}}(i.id,s.blob,e.get("renderingFormats"))),o+=n.render(s)}catch(e){o+=n.renderError(i.content,e)}return o})))}))}})},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PlantUMLRenderer=void 0;const i=n(2),o=n(7);var a;!function(e){e[e.Timeout=5e3]="Timeout"}(a||(a={}));t.PlantUMLRenderer=class{constructor(e){this._settings=e}fetchWithTimeout(e,t){return r(this,void 0,void 0,(function*(){const{timeout:n=a.Timeout}=t,r=new AbortController,i=setTimeout(()=>r.abort(),n),o=yield fetch(e,Object.assign(Object.assign({},t),{signal:r.signal}));return clearTimeout(i),o}))}fetchBlob(e){return r(this,void 0,void 0,(function*(){let t;try{t=yield this.fetchWithTimeout(e,{})}catch(e){if(console.error("PlantUML::fetchBlob::error",e.name,e),"AbortError"===e.name)throw"Request timeout";throw"Request error"}if(200===t.status||400===t.status){console.info("PlantUML::fetchBlob::response",t);const e=yield(yield t.blob()).arrayBuffer();return Buffer.from(e).toString("base64")}throw console.error("PlantUML::fetchBlob::error",t),`${t.status} - ${t.statusText}`}))}execute(e){return r(this,void 0,void 0,(function*(){let t,n,r;const a=this._settings.get("renderingFormats");switch(this._settings.get("renderingType")){case"public":return t=o.encode(e),n=i.SettingDefaults.RenderingServer+"/"+a+"/"+t,r=i.SettingDefaults.RenderingServer+"/png/"+t,{url:n,blob:yield this.fetchBlob(n),imageUrl:r};case"private":return t=o.encode(e),n=this._settings.get("renderingServer")+"/"+a+"/"+t,r=this._settings.get("renderingServer")+"/png/"+t,{url:n,blob:yield this.fetchBlob(n),imageUrl:r};default:throw"renderingType not implemented: "+this._settings.get("renderingType")}}))}}},function(e,t,n){e.exports={encode:n(8).encode,decode:n(11).decode}},function(e,t,n){"use strict";var r=n(9),i=n(10);e.exports.encode=function(e){var t=r(e);return i(t)}},function(e,t,n){"use strict";const r=n(3);e.exports=function(e){return r.deflateRawSync(e,{level:9}).toString("binary")}},function(e,t,n){"use strict";function r(e){return e<10?String.fromCharCode(48+e):(e-=10)<26?String.fromCharCode(65+e):(e-=26)<26?String.fromCharCode(97+e):0===(e-=26)?"-":1===e?"_":"?"}function i(e,t,n){var i=(3&e)<<4|t>>4,o=(15&t)<<2|n>>6,a=63&n,s="";return s+=r(63&e>>2),s+=r(63&i),s+=r(63&o),s+=r(63&a)}e.exports=function(e){for(var t="",n=0;n<e.length;n+=3)n+2===e.length?t+=i(e.charCodeAt(n),e.charCodeAt(n+1),0):n+1===e.length?t+=i(e.charCodeAt(n),0,0):t+=i(e.charCodeAt(n),e.charCodeAt(n+1),e.charCodeAt(n+2));return t}},function(e,t,n){"use strict";var r=n(12),i=n(13);e.exports.decode=function(e){var t=i(e);return r(t)}},function(e,t,n){"use strict";const r=n(3);e.exports=function(e){return r.inflateRawSync(Buffer.from(e,"binary")).toString()}},function(e,t,n){"use strict";function r(e){var t=e.charCodeAt(0);return"_"===e?63:"-"===e?62:t>=97?t-61:t>=65?t-55:t>=48?t-48:"?"}function i(e){var t=r(e[0]),n=r(e[1]),i=r(e[2]);return[t<<2|n>>4&63,n<<4&240|i>>2&15,i<<6&192|63&r(e[3])]}e.exports=function(e){var t="",n=0;for(n=0;n<e.length;n+=4){var r=i(e.substring(n,n+4));t+=String.fromCharCode(r[0]),t+=String.fromCharCode(r[1]),t+=String.fromCharCode(r[2])}return t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.View=void 0;const r=Buffer.from("89504e47","hex");t.View=class{constructor(e){this._settings=e}renderSvg(e){return console.log("renderSvg",e,this._settings),t=e.blob,0==Buffer.from(t,"base64").compare(r,0,4,0,4)?this.renderPng(e):`<div class="flex-center">\n                    <div data-url="${e.url}" data-image-url="${e.imageUrl}">\n                        ${n=e.blob,Buffer.from(n,"base64").toString("utf-8")}\n                    </div>\n                </div>`;var t,n}renderPng(e){return console.log("renderPng",e,this._settings),`<div class="flex-center">\n                    <img alt="PlantUML Diagram" src="data:image/png;base64,${e.blob}" data-url="${e.url}" data-image-url="${e.imageUrl}" />\n                </div>`}renderAsciArt(e){return console.log("renderAsciArt",e,this._settings),`<div class="flex-center">\n                    <pre data-url="${e.url}" data-image-url="${e.imageUrl}">${Buffer.from(e.blob,"base64").toString("utf-8")}</pre>\n                </div>`}render(e){switch(this._settings.get("renderingFormats")){case"svg":return this.renderSvg(e);case"png":return this.renderPng(e);case"txt":return this.renderAsciArt(e);default:throw"renderingFormat not implemented: "+this._settings.get("renderingFormats")}}renderError(e,t){return console.log("renderError",e,t),`<div class="flex-center"><span class="error-icon">X</span><span>PlantUML Error:</span><span>${t}</span></div>`}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectsCache=void 0;t.ObjectsCache=class{constructor(){this._cache={}}addCachedObject(e,t){this._cache[e]={data:t}}getCachedObject(e){if(e in this._cache)return this._cache[e].data}clear(){this._cache={}}}},function(e,t){e.exports=require("os")}]);